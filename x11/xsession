#!/bin/bash

# ConsoleKit
if [ -x /usr/bin/ck-launch-session ]; then
    PREPEND="$PREPEND /usr/bin/ck-launch-session"
fi

# GPG/SSH agent
if [ -z "$SSH_AUTH_SOCK" ] && [ -x /usr/bin/ssh-agent ]; then
    PREPEND="$PREPEND ssh-agent"
fi

# DBus
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ] && [ -x /usr/bin/dbus-launch ]; then
    PREPEND="$PREPEND dbus-launch --exit-with-session"
fi

# If we have to prepend something, restart
if [ -z "$XSESSION_RESTARTED" ]; then
    export XSESSION_RESTARTED=1
    exec $PREPEND bash $0 "$@"
fi

# X resources
[ -f ~/.Xresources ] && xrdb -merge ~/.Xresources

# Keyboard setup
setxkbmap -layout us -variant altgr-intl -option ctrl:nocaps -option compose:menu

# Other X settings
xset b off
xset dpms 300 600 900
xset m 1 0
xset r rate 200 40
xset s off

# Add SSH key
if [ -n "$SSH_AUTH_SOCK" ] && [ -e ~/.ssh/id_rsa ]; then
    [ -z "$SSH_ASKPASS" ] && [ -x /usr/lib/openssh/ssh-askpass ] && export SSH_ASKPASS=/usr/lib/openssh/ssh-askpass
    [ -n "$SSH_ASKPASS" ] && (sleep 1 && ssh-add ~/.ssh/id_rsa < /dev/null) &
fi

# Other applications
[ -x /usr/bin/gstm ]                        && (sleep 2 && /usr/bin/gstm) &
[ -x /usr/bin/SpiderOak ]                   && (sleep 2 && /usr/bin/SpiderOak) &

# Window manager
[ -x /usr/bin/awesome ]                     && exec awesome

# Fallback to xterm
[ -x /usr/bin/xterm ]                       && exec xterm
